#!/usr/bin/env bash

set -euo pipefail

if [[ $# -lt 1 ]]; then
  echo "Error: provide the command you want to run in the container as an argument (e.g. bash)"
  return
fi
cluster="$(aws ecs list-clusters --query clusterArns | jq -c '.[]' -r | awk -F '/' '{print $2}' | fzf)"
preview="aws ecs describe-tasks --cluster $cluster --tasks {} --query 'tasks[0].taskDefinitionArn' --output text | sed 's|.*/||'"
taskArn="$(aws ecs list-tasks --cluster "$cluster" --query taskArns | jq -c '.[]' -r | fzf --preview="$preview")"
containerName="$(aws ecs describe-tasks --tasks $taskArn --cluster $cluster --query 'tasks[0].containers[].name' | jq -c '.[]' -r | fzf)"
aws ecs execute-command \
  --cluster "$cluster" \
  --task "$(echo -n "$taskArn" | awk -F '/' '{print $3}')" \
  --container "$containerName" \
  --interactive \
  --command $1
